#!/usr/bin/ansible-playbook -K
---
- hosts: localhost
  tasks:
    - name: Link dotfiles
      file:
        state: link
        force: yes
        src: "{{ playbook_dir }}/files/{{ item.source }}"
        path: "{{ item.dest }}"
      loop:
        - source: bash/bash_profile
          dest: ~/.bash_profile

        - source: bash/bashrc
          dest: ~/.bashrc

        - source: git/gitconfig
          dest: ~/.gitconfig

        - source: git/gitignore_global
          dest: ~/.gitignore_global

        - source: mpv
          dest: ~/.config/mpv

        - source: shellcheck/shellcheckrc
          dest: ~/.shellcheckrc

        - source: systemd-tmpfiles
          dest: ~/.config/user-tmpfiles.d

        - source: vim/vimrc
          dest: ~/.vimrc

    - name: Add Google Cloud repo
      become: yes
      yum_repository:
        name: google-cloud-sdk
        description: Google Cloud SDK
        baseurl: https://packages.cloud.google.com/yum/repos/cloud-sdk-el8-x86_64
        enabled: yes
        gpgcheck: yes
        repo_gpgcheck: yes
        gpgkey:
          - https://packages.cloud.google.com/yum/doc/yum-key.gpg
          - https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg

    - name: Add Helm COPR repo
      become: yes
      yum_repository:
        name: copr:copr.fedorainfracloud.org:cerenit:helm
        description: Copr repo for helm owned by cerenit
        baseurl: https://download.copr.fedorainfracloud.org/results/cerenit/helm/fedora-$releasever-$basearch
        enabled: yes
        skip_if_unavailable: yes
        gpgcheck: yes
        repo_gpgcheck: no
        gpgkey: https://download.copr.fedorainfracloud.org/results/cerenit/helm/pubkey.gpg

    - name: Install packages
      become: yes
      register: packages
      dnf:
        state: latest # noqa 403
        name:
          - '@Development Tools'
          - ansible
          - bash-completion
          - bind-utils
          - glibc-langpack-en
          - helm
          - kubectl
          - nmap
          - openssl
          - python3-ansible-lint
          - python3-flake8
          - ruby
          - ShellCheck
          - tmux
          - vim-X11
          - youtube-dl

    - name: Package report
      block:
        - name: Gather changed packages
          register: package_report
          command: dnf history info
          args:
            warn: no
          # "dnf history info" sometimes throws a python traceback
          failed_when: no

        - name: Show changed packages
          debug:
            var: package_report.stdout_lines
      when: packages is changed
